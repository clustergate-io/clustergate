---
# PodCheck: Verify ingress-nginx pods are running and ready
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: ingress-controller-ready
spec:
  description: "Verifies that the ingress-nginx controller pods are running and ready"
  severity: critical
  category: networking
  podCheck:
    namespace: ingress-nginx
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/component: controller
    minReady: 2
---
# HTTPCheck: Verify Vault is healthy
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: vault-health
spec:
  description: "Verifies that HashiCorp Vault is healthy and unsealed"
  severity: warning
  category: security
  httpCheck:
    url: "https://vault.vault.svc:8200/v1/sys/health"
    expectedStatusCodes: [200]
    timeoutSeconds: 5
    insecureSkipTLSVerify: true
---
# ResourceCheck: Verify cert-manager deployment is available
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: cert-manager-ready
spec:
  description: "Verifies that the cert-manager deployment is available"
  severity: critical
  category: security
  resourceCheck:
    apiVersion: apps/v1
    kind: Deployment
    namespace: cert-manager
    name: cert-manager
    conditions:
      - type: Available
        status: "True"
---
# PromQLCheck: Verify etcd cluster has enough members
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: etcd-cluster-healthy
spec:
  description: "Verifies that at least 3 etcd instances are reporting as up"
  severity: critical
  category: control-plane
  promqlCheck:
    endpoint: "http://prometheus.monitoring.svc:9090"
    query: 'up{job="etcd"} == 1'
    condition:
      type: resultCount
      operator: gte
      threshold: 3
    timeoutSeconds: 10
---
# ScriptCheck: Run a custom connectivity test as a Kubernetes Job
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: dns-external-resolution
spec:
  description: "Verifies that external DNS resolution works from within the cluster"
  severity: critical
  category: networking
  scriptCheck:
    image: busybox:latest
    command: ["sh", "-c"]
    args: ["nslookup google.com > /dev/null 2>&1 && echo 'DNS resolution OK' || exit 1"]
    timeoutSeconds: 30
---
# ScriptCheck: Verify NFS mount is accessible
apiVersion: preflight.platform.io/v1alpha1
kind: PreflightCheck
metadata:
  name: nfs-mount-check
spec:
  description: "Verifies that the NFS share is accessible and writable"
  severity: warning
  category: storage
  scriptCheck:
    image: busybox:latest
    command: ["sh", "-c"]
    args: ["touch /mnt/test-write && rm /mnt/test-write && echo 'NFS OK'"]
    timeoutSeconds: 60
    serviceAccountName: preflight-storage-sa
    volumes:
      - name: nfs-vol
        nfs:
          server: "10.0.0.5"
          path: "/exports/data"
    volumeMounts:
      - name: nfs-vol
        mountPath: /mnt
